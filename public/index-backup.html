<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Manager</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
      }

      .api-key-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .api-key-section h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .api-key-input {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .api-key-input input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .api-key-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .api-key-status.valid {
        background: #d4edda;
        color: #155724;
      }

      .api-key-status.invalid {
        background: #f8d7da;
        color: #721c24;
      }

      .actions {
        margin-bottom: 20px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      button.secondary {
        background: #6c757d;
      }

      button.secondary:hover {
        background: #545b62;
      }

      button.danger {
        background: #dc3545;
      }

      button.danger:hover {
        background: #c82333;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        margin: 0;
      }

      .close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        color: #666;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .type-btn {
        flex: 1;
        padding: 12px;
        background: #f8f9fa;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }

      .type-btn.active {
        background: #e7f3ff;
        border-color: #007bff;
        color: #007bff;
      }

      .qr-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .qr-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .qr-image {
        width: 100%;
        height: auto;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .qr-info {
        margin-bottom: 15px;
      }

      .qr-type {
        display: inline-block;
        padding: 4px 8px;
        background: #e7f3ff;
        color: #007bff;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .qr-data {
        color: #666;
        font-size: 14px;
        word-break: break-word;
      }

      .qr-actions {
        display: flex;
        gap: 10px;
      }

      .qr-actions button {
        flex: 1;
        padding: 8px;
        font-size: 13px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 8px;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .empty-state p {
        color: #666;
        margin-bottom: 20px;
      }

      .dynamic-fields {
        display: none;
      }

      .dynamic-fields.active {
        display: block;
      }

      .qr-url {
        font-family: monospace;
        font-size: 12px;
        color: #666;
        margin-top: 8px;
        word-break: break-all;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }

      .error-message.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>QR Code Manager</h1>
        <p class="subtitle">
          Create dynamic QR codes that you can update anytime
        </p>
      </header>

      <div class="api-key-section">
        <h3>üîë API Authentication Required</h3>
        <div class="api-key-input">
          <input type="password" id="apiKeyInput" placeholder="Enter your API key..." />
          <button id="setApiKeyBtn">Set API Key</button>
          <span id="apiKeyStatus" class="api-key-status">Not Set</span>
        </div>
        <p style="margin-top: 10px; font-size: 12px; color: #856404;">
          Contact your administrator to get an API key for accessing this service.
        </p>
      </div>

      <div class="actions">
        <button id="createBtn" disabled>+ Create QR Code</button>
        <button class="danger" id="clearAllBtn" style="display: none;" disabled>üóëÔ∏è Clear All</button>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <div id="qrGrid" class="qr-grid"></div>
    </div>

    <div id="createModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Create QR Code</h2>
          <button class="close" id="closeModalBtn">&times;</button>
        </div>

        <div class="type-selector">
          <button class="type-btn active" data-type="link" id="linkTypeBtn">
            Link
          </button>
          <button class="type-btn" data-type="vcard" id="vcardTypeBtn">
            Contact Card
          </button>
        </div>

        <form id="qrForm">
          <div id="linkFields" class="dynamic-fields active">
            <div class="form-group">
              <label>Destination URL</label>
              <input type="url" id="url" placeholder="https://example.com" required />
            </div>
          </div>

          <div id="vcardFields" class="dynamic-fields">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="firstName" placeholder="John" required />
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="lastName" placeholder="Doe" required />
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" placeholder="john@example.com" />
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="phone" placeholder="+1234567890" />
            </div>
            <div class="form-group">
              <label>Organization</label>
              <input type="text" id="organization" placeholder="Company Inc." />
            </div>
            <div class="form-group">
              <label>Title</label>
              <input type="text" id="title" placeholder="Software Engineer" />
            </div>
            <div class="form-group">
              <label>Website</label>
              <input type="url" id="website" placeholder="https://example.com" />
            </div>
          </div>

          <button type="submit" id="submitBtn">Create QR Code</button>
        </form>
      </div>
    </div>

    <script>
      let currentType = 'link'
      let editingId = null
      let apiKey = localStorage.getItem('qr_api_key') || ''

      // Initialize API key status
      if (apiKey) {
        document.getElementById('apiKeyInput').value = apiKey
        updateApiKeyStatus(true)
      }

      // Event listeners (CSP-compliant)
      document.addEventListener('DOMContentLoaded', function() {
        // API Key button
        document.getElementById('setApiKeyBtn').addEventListener('click', setApiKey)
        
        // Main action buttons
        document.getElementById('createBtn').addEventListener('click', openCreateModal)
        document.getElementById('clearAllBtn').addEventListener('click', clearAllQRCodes)
        
        // Modal controls
        document.getElementById('closeModalBtn').addEventListener('click', closeModal)
        
        // Type selector buttons
        document.getElementById('linkTypeBtn').addEventListener('click', () => selectType('link'))
        document.getElementById('vcardTypeBtn').addEventListener('click', () => selectType('vcard'))
        
        // Form submission
        document.getElementById('qrForm').addEventListener('submit', handleSubmit)
        
        // Load QR codes on page load if API key is available
        if (apiKey) {
          loadQRCodes()
        }
      })

      function setApiKey() {
        const input = document.getElementById('apiKeyInput')
        const key = input.value.trim()
        
        if (key) {
          apiKey = key
          localStorage.setItem('qr_api_key', key)
          updateApiKeyStatus(true)
          loadQRCodes() // Try to load QR codes with new key
        } else {
          updateApiKeyStatus(false)
        }
      }

      function updateApiKeyStatus(isValid) {
        const status = document.getElementById('apiKeyStatus')
        const createBtn = document.getElementById('createBtn')
        
        if (isValid) {
          status.textContent = 'Valid'
          status.className = 'api-key-status valid'
          createBtn.disabled = false
        } else {
          status.textContent = 'Invalid'
          status.className = 'api-key-status invalid'
          createBtn.disabled = true
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage')
        errorDiv.textContent = message
        errorDiv.classList.add('show')
        setTimeout(() => {
          errorDiv.classList.remove('show')
        }, 5000)
      }

      async function makeAuthenticatedRequest(url, options = {}) {
        if (!apiKey) {
          showError('API key is required. Please set your API key first.')
          return null
        }

        const headers = {
          'Content-Type': 'application/json',
          'X-API-Key': apiKey,
          ...options.headers
        }

        try {
          const response = await fetch(url, {
            ...options,
            headers
          })

          if (response.status === 401) {
            showError('Invalid API key. Please check your API key and try again.')
            updateApiKeyStatus(false)
            return null
          }

          if (!response.ok) {
            const errorData = await response.json()
            showError(errorData.error || 'Request failed')
            return null
          }

          return response
        } catch (error) {
          showError('Network error: ' + error.message)
          return null
        }
      }

      async function loadQRCodes() {
        const response = await makeAuthenticatedRequest('/api/qr')
        if (!response) return

        const codes = await response.json()

        const grid = document.getElementById('qrGrid')
        const clearAllBtn = document.getElementById('clearAllBtn')

        if (codes.length === 0) {
          grid.innerHTML = `
          <div class="empty-state">
            <h3>No QR codes yet</h3>
            <p>Create your first QR code to get started</p>
            <button id="emptyCreateBtn" ${!apiKey ? 'disabled' : ''}>+ Create QR Code</button>
          </div>
        `
          // Add event listener to empty state button
          const emptyCreateBtn = document.getElementById('emptyCreateBtn')
          if (emptyCreateBtn) {
            emptyCreateBtn.addEventListener('click', openCreateModal)
          }
          clearAllBtn.style.display = 'none'
          return
        }

        // Show clear all button when there are QR codes
        clearAllBtn.style.display = 'inline-block'
        clearAllBtn.disabled = !apiKey

        grid.innerHTML = codes
          .map(
            (code) => `
        <div class="qr-card">
          <img class="qr-image" src="${code.qrImage}" alt="QR Code">
          <div class="qr-info">
            <div class="qr-type">${
              code.type === 'link' ? 'Link' : 'Contact Card'
            }</div>
            <div class="qr-data">
              ${
                code.type === 'link'
                  ? `‚Üí ${code.data.url}`
                  : `${code.data.firstName} ${code.data.lastName}`
              }
            </div>
            <div class="qr-url">${code.qrUrl}</div>
          </div>
          <div class="qr-actions">
            <button class="secondary edit-btn" data-id="${code.id}" ${!apiKey ? 'disabled' : ''}>Edit</button>
            <button class="secondary download-btn" data-id="${code.id}" ${!apiKey ? 'disabled' : ''}>Download</button>
            <button class="danger delete-btn" data-id="${code.id}" ${!apiKey ? 'disabled' : ''}>Delete</button>
          </div>
        </div>
      `
          )
          .join('')

        // Add event listeners to dynamically created buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => editQRCode(e.target.dataset.id))
        })
        document.querySelectorAll('.download-btn').forEach(btn => {
          btn.addEventListener('click', (e) => downloadQR(e.target.dataset.id))
        })
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => deleteQRCode(e.target.dataset.id))
        })
      }

      function selectType(type) {
        currentType = type

        document.querySelectorAll('.type-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.type === type)
        })

        document.querySelectorAll('.dynamic-fields').forEach((field) => {
          field.classList.remove('active')
        })

        document.getElementById(type + 'Fields').classList.add('active')
      }

      function openCreateModal() {
        if (!apiKey) {
          showError('Please set your API key first')
          return
        }
        
        editingId = null
        document.getElementById('modalTitle').textContent = 'Create QR Code'
        document.getElementById('submitBtn').textContent = 'Create QR Code'
        document.getElementById('qrForm').reset()
        document.getElementById('createModal').classList.add('active')
      }

      async function editQRCode(id) {
        if (!apiKey) {
          showError('Please set your API key first')
          return
        }

        const response = await makeAuthenticatedRequest(`/api/qr/${id}`)
        if (!response) return

        const code = await response.json()

        editingId = id
        currentType = code.type

        selectType(code.type)

        if (code.type === 'link') {
          document.getElementById('url').value = code.data.url
        } else {
          document.getElementById('firstName').value = code.data.firstName
          document.getElementById('lastName').value = code.data.lastName
          document.getElementById('email').value = code.data.email || ''
          document.getElementById('phone').value = code.data.phone || ''
          document.getElementById('organization').value =
            code.data.organization || ''
          document.getElementById('title').value = code.data.title || ''
          document.getElementById('website').value = code.data.website || ''
        }

        document.getElementById('modalTitle').textContent = 'Edit QR Code'
        document.getElementById('submitBtn').textContent = 'Update QR Code'
        document.getElementById('createModal').classList.add('active')
      }

      function closeModal() {
        document.getElementById('createModal').classList.remove('active')
      }

      async function handleSubmit(e) {
        e.preventDefault()

        if (!apiKey) {
          showError('Please set your API key first')
          return
        }

        let data

        if (currentType === 'link') {
          data = { url: document.getElementById('url').value }
        } else {
          data = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            organization: document.getElementById('organization').value,
            title: document.getElementById('title').value,
            website: document.getElementById('website').value,
          }
        }

        const url = editingId ? `/api/qr/${editingId}` : '/api/qr'
        const method = editingId ? 'PUT' : 'POST'

        const response = await makeAuthenticatedRequest(url, {
          method,
          body: JSON.stringify({ type: currentType, data }),
        })

        if (response) {
          closeModal()
          loadQRCodes()
        }
      }

      async function deleteQRCode(id) {
        if (!apiKey) {
          showError('Please set your API key first')
          return
        }

        if (!confirm('Delete this QR code? This cannot be undone.')) return

        const response = await makeAuthenticatedRequest(`/api/qr/${id}`, { method: 'DELETE' })
        if (response) {
          loadQRCodes()
        }
      }

      async function downloadQR(id) {
        if (!apiKey) {
          showError('Please set your API key first')
          return
        }

        const response = await makeAuthenticatedRequest(`/api/qr/${id}/image`)
        if (!response) return

        const blob = await response.blob()
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `qr-code-${id}.png`
        a.click()
      }

      async function clearAllQRCodes() {
        if (!apiKey) {
          showError('Please set your API key first')
          return
        }

        if (!confirm("Are you sure you want to delete ALL QR codes? This cannot be undone.")) return
        
        const response = await makeAuthenticatedRequest("/api/qr/clear-all", { method: "DELETE" })
        if (response) {
          loadQRCodes()
        }
      }
    </script>
  </body>
</html>
